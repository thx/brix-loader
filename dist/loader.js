define(["./constant.js","./option.js","./util.js"],function(Constant,Options,Util){function boot(e){e=e&&e.element||e||document;var t=Util.defer(),n=Util.queue(),i=function(){var t=[];1===e.nodeType&&e.getAttribute(Constant.ATTRS.id)&&t.push(e);var n=e.getElementsByTagName("*");return Util.each(n,function(e){1===e.nodeType&&e.getAttribute(Constant.ATTRS.id)&&t.push(e)}),t}();return Util.each(i,function(e){n.queue(function(t){init(e).then(void 0,function(e){console.error(e)}).finally(function(){t()})})}),n.queue(function(){t.resolve(e)}).dequeue(),t.promise}function init(element){var deferred=Util.defer(),promise=deferred.promise,queue=Util.queue();if(element.getAttribute(Constant.ATTRS.cid))return deferred.resolve(),promise;var options=Options.parseOptions(element),BrixImpl,instance,label="module "+options.moduleId+" "+options.clientId;return console.group(label),console.time(label),promise.finally(function(){console.timeEnd(label),console.groupEnd(label)}),queue.queue(function(e){load(options.moduleId).then(function(t){BrixImpl=t,e()})}).queue(function(e){try{instance=new BrixImpl(options),instance.options=instance.options||{},Util.extend(instance.options,options),Util.extend(instance,Util.pick(options,Constant.OPTIONS)),e()}catch(t){deferred.reject(t)}}).queue(function(e){instance._destroy=instance.destroy,instance.destroy=function(){destroy(instance)},e()}).queue(function(e){cache(instance),e()}).queue(function(e){Util.each(Constant.EVENTS,function(e){instance.on&&instance.on(e+Constant.NAMESPACE,function(e){console.log(label,e.type)})}),e()}).queue(function(e){instance.init&&instance.init(),console.log(label,"init"),e()}).queue(function(e){instance._render||(instance._render=instance.render,instance.render=function(){var e;instance.childClientIds.length&&(e=!0,Util.each(instance.childClientIds,function(e){CACHE[e]&&destroy(e)})),instance._render.apply(this,arguments),e&&boot(instance.element);var t=instance.element;t.nodeType&&!t.getAttribute(Constant.ATTRS.cid)?t.setAttribute(Constant.ATTRS.cid,options.clientId):t.length&&Util.each(t,function(e){e.nodeType&&!e.getAttribute(Constant.ATTRS.cid)&&e.setAttribute(Constant.ATTRS.cid,options.clientId)})});try{instance.render()}catch(t){deferred.reject(t)}console.log(label,"render"),e()}).queue(function(next){instance.on&&Util.each(options.events,function(item){instance.on(item.type+Constant.NAMESPACE,function(event,extraParameters){item.fn in instance?instance[item.fn].apply(instance,(extraParameters?[extraParameters]:[event]).concat(item.params)):eval(item.handler)})}),next()}).queue(function(e){var t=element.getElementsByTagName("*"),n=!1;Util.each(t,function(e){1===e.nodeType&&!n&&e.getAttribute(Constant.ATTRS.id)&&(n=!0)}),n?boot(instance).then(function(){e()}):e()}).queue(function(){instance.triggerHandler&&instance.triggerHandler(Constant.EVENTS.ready),deferred.resolve()}).dequeue(),promise}function destroy(e){if(!e)return this;if(Util.isNumber(e)&&(e=CACHE[e]),e.isQuery)return void Util.each(e.toArray(),function(e){destroy(e)});if(1===e.nodeType&&(e=CACHE[e.getAttribute(Constant.ATTRS.cid)]),!e)return this;e.childClientIds.length&&Util.each(e.childClientIds,function(e){destroy(e)}),e._destroy&&e._destroy(),delete CACHE[e.clientId];var t=CACHE[e.parentClientId];return t&&(t.childClientIds=Util.without(t.childClientIds,e.clientId)),e.triggerHandler(Constant.EVENTS.destroy),e.off&&Util.each(e.options.events,function(t){e.off(t.type+Constant.NAMESPACE)}),e.element.parentNode&&e.element.parentNode.removeChild(e.element),console.log("module",e.moduleId,e.clientId,"destroy"),this}function load(e){var t=Util.defer(),n=t.promise;return require([e],function(e){t.resolve(e)}),n.then(void 0,console.error),n}function cache(e){CACHE[e.clientId]=e;var t=CACHE[e.parentClientId];t&&t.childClientIds.push(e.clientId)}function query(e){var t=[],n=[];return e.nodeType&&t.push(CACHE[e.getAttribute(Constant.ATTRS.cid)]),Util.isNumber(e)&&Util.each(CACHE,function(i){i.moduleId===e&&(t.push(i),Util.each(i.constructor.prototype,function(e,t){Util.isFunction(e)&&n.push(t)}))}),Util.each(Util.unique(n),function(e){t[e]=function(){var t=[].slice.call(arguments);Util.each(this,function(n){n[e]&&n[e].apply(n,t)})}}),t}function tree(){function e(t,n){return Util.each(CACHE,function(i){i.parentClientId===t&&n.push({name:i.moduleId+","+i.clientId,children:e(i.clientId,[])})}),n}var t={name:"root",children:[]};return e(-1,t.children),t}var CACHE={};return{CACHE:CACHE,boot:boot,init:init,destroy:destroy,query:query,tree:tree,Util:Util,Constant:Constant,Options:Options}});